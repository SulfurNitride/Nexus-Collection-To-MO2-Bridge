cmake_minimum_required(VERSION 3.14)
project(NexusBridge VERSION 2.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Find required packages
find_package(CURL REQUIRED)
find_package(Threads REQUIRED)

# Include directories for bundled libraries
include_directories(${CMAKE_SOURCE_DIR}/include)

# Global definitions for Windows
if(WIN32)
    add_compile_definitions(NOMINMAX LOOT_STATIC)
endif()

# libloot paths
set(LIBLOOT_DIR "${CMAKE_SOURCE_DIR}/external/libloot/cpp")
set(LIBLOOT_INCLUDE_DIR "${LIBLOOT_DIR}/include")
set(LIBLOOT_CXXBRIDGE_DIR "${CMAKE_SOURCE_DIR}/external/libloot/target/cxxbridge")

# List all C++ wrapper sources
file(GLOB LIBLOOT_CPP_SOURCES "${LIBLOOT_DIR}/src/api/*.cpp" "${LIBLOOT_DIR}/src/api/metadata/*.cpp" "${LIBLOOT_DIR}/src/api/exception/*.cpp")

# Add the generated cxxbridge source (must be generated by cargo build first)
set(LIBLOOT_BRIDGE_SOURCE "${LIBLOOT_CXXBRIDGE_DIR}/libloot-cpp/src/lib.rs.cc")

# Search for cxx.cc (support library for cxx crate) in the cxxbridge output
file(GLOB_RECURSE LIBLOOT_CXX_SUPPORT_SOURCE "${LIBLOOT_CXXBRIDGE_DIR}/rust/*.cc")

if(WIN32)
    # Windows
    set(LIBLOOT_LIB_DIR "${CMAKE_SOURCE_DIR}/external/libloot/target/release")
    find_library(LIBLOOT_LIB NAMES loot loot.dll libloot libloot.dll PATHS ${LIBLOOT_LIB_DIR} NO_DEFAULT_PATH)
    find_library(LIBLOOT_CPP_LIB NAMES loot_cpp libloot_cpp PATHS ${LIBLOOT_LIB_DIR} NO_DEFAULT_PATH)
else()
    # Linux
    set(LIBLOOT_LIB_DIR "${CMAKE_SOURCE_DIR}/external/libloot/target/release")
    find_library(LIBLOOT_LIB NAMES loot libloot PATHS ${LIBLOOT_LIB_DIR} NO_DEFAULT_PATH)
    if(NOT LIBLOOT_LIB)
        message(WARNING "Could not find libloot.so in ${LIBLOOT_LIB_DIR}, falling back to hardcoded path")
        set(LIBLOOT_LIB "${LIBLOOT_LIB_DIR}/libloot.so")
    endif()

    find_library(LIBLOOT_CPP_LIB NAMES libloot_cpp PATHS ${LIBLOOT_LIB_DIR} NO_DEFAULT_PATH)
    if(NOT LIBLOOT_CPP_LIB)
        set(LIBLOOT_CPP_LIB "${LIBLOOT_LIB_DIR}/liblibloot_cpp.a")
    endif()
endif()

# Main CLI executable
add_executable(NexusBridge
    src/nexus_bridge.cpp
    src/fomod_installer.cpp
    include/pugixml/pugixml.cpp
    ${LIBLOOT_CPP_SOURCES}
    ${LIBLOOT_BRIDGE_SOURCE}
    ${LIBLOOT_CXX_SUPPORT_SOURCE}
)

target_include_directories(NexusBridge PRIVATE
    ${LIBLOOT_INCLUDE_DIR}
    ${LIBLOOT_CXXBRIDGE_DIR}
    "${LIBLOOT_DIR}/src"
)

target_link_libraries(NexusBridge PRIVATE
    CURL::libcurl
    Threads::Threads
    ${LIBLOOT_LIB}
    ${LIBLOOT_CPP_LIB}
)

if(WIN32)
    target_link_libraries(NexusBridge PRIVATE ntdll ws2_32 bcrypt Userenv Advapi32)
endif()

# Set rpath so executable can find libloot.so at runtime
if(UNIX)
    set_target_properties(NexusBridge PROPERTIES
        BUILD_RPATH "${LIBLOOT_LIB_DIR}"
        INSTALL_RPATH "$ORIGIN"
    )
endif()

if(MSVC)
    target_compile_options(NexusBridge PRIVATE /W4 /wd4996 /wd4101 /wd4251)
    # Use static runtime to avoid requiring VC++ Redistributable
    set_property(TARGET NexusBridge PROPERTY MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
else()
    target_compile_options(NexusBridge PRIVATE -Wall -Wextra)
endif()

# Install target
install(TARGETS NexusBridge DESTINATION bin)
