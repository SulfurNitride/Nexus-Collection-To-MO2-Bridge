name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libpugixml-dev cmake build-essential

    - name: Install Rust (for libloot)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable

    - name: Build libloot
      run: |
        cd external/libloot
        cargo build --release --lib
        # Debug: List generated files to find the correct library name
        ls -l target/release/
        # Handle potential naming variations (libloot.so vs liblibloot.so)
        mkdir -p ../../build
        find target/release -name "libloot.so" -exec cp {} ../../build/ \; -o -name "liblibloot.so" -exec cp {} ../../build/ \;

    - name: Build NexusBridge
      run: |
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        make

    - name: Download 7-Zip (Linux)
      run: |
        wget https://www.7-zip.org/a/7z2408-linux-x64.tar.xz
        tar -xf 7z2408-linux-x64.tar.xz 7zzs
        chmod +x 7zzs

    - name: Package Linux
      run: |
        mkdir dist
        cp build/NexusBridge dist/
        # Copy the library we found earlier
        cp build/*.so dist/libloot.so
        cp 7zzs dist/
        tar -czf NexusBridge-Linux-x64.tar.gz -C dist .

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: NexusBridge-Linux-x64.tar.gz

  build-windows:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (for libloot)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable

    - name: Install Dependencies (vcpkg)
      run: |
        vcpkg install curl:x64-windows
        vcpkg install pugixml:x64-windows
        vcpkg integrate install

    - name: Build libloot
      run: |
        cd external/libloot
        cargo build --release --lib
        # Result is in target/release/loot.dll (libloot creates loot.dll on Windows usually)

    - name: Build NexusBridge
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ..
        cmake --build . --config Release

    - name: Download 7-Zip (Windows)
      run: |
        Invoke-WebRequest -Uri "https://www.7-zip.org/a/7z2408-extra.7z" -OutFile "7z-extra.7z"
        7z x 7z-extra.7z -o7zip_extra
        Copy-Item "7zip_extra/7za.exe" .

    - name: Package Windows
      run: |
        mkdir dist
        copy build\Release\NexusBridge.exe dist\
        copy external\libloot\target\release\loot.dll dist\libloot.dll
        copy 7za.exe dist\
        # We might need libcurl.dll depending on vcpkg linkage, usually vcpkg handles it or we static link
        # For safety, we'll try to find and copy it if it exists, or rely on static linking
        
    - name: Create Zip
      run: |
        Compress-Archive -Path dist/* -DestinationPath NexusBridge-Windows-x64.zip

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: NexusBridge-Windows-x64.zip

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: .
    
    - uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: .

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          NexusBridge-Linux-x64.tar.gz
          NexusBridge-Windows-x64.zip
